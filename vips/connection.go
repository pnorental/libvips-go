// Code generated by github.com/cshum/vipsgen from libvips 8.16.1; DO NOT EDIT.

package vips

// #include "connection.h"
import "C"
import (
	"fmt"
	"github.com/cshum/vipsgen/pointer"
	"io"
	"sync"
	"unsafe"
)

// Source contains a libvips VipsSourceCustom and manages its lifecycle.
type Source struct {
	reader io.ReadCloser
	seeker io.Seeker
	src    *C.VipsSourceCustom
	ptr    unsafe.Pointer
	lock   sync.Mutex
}

// NewSource creates Source from reader
func NewSource(reader io.ReadCloser) *Source {
	Startup(nil)
	s := &Source{reader: reader}
	seeker, ok := reader.(io.ReadSeeker)
	if ok {
		s.seeker = seeker
		s.ptr = pointer.Save(s)
		s.src = C.create_go_custom_source_with_seek(s.ptr)
	} else {
		s.ptr = pointer.Save(s)
		s.src = C.create_go_custom_source(s.ptr)
	}
	return s
}

// Close source
func (s *Source) Close() {
	if s == nil {
		return
	}
	s.lock.Lock()
	if s.ptr != nil {
		C.clear_source(&s.src)
		pointer.Unref(s.ptr)
		s.ptr = nil
		s.lock.Unlock()
		if s.reader != nil {
			_ = s.reader.Close()
			s.reader = nil
		}
		log("vipsgen", LogLevelDebug, fmt.Sprintf("closing source %p", s))
	} else {
		s.lock.Unlock()
	}
}

// Target contains a libvips VipsTargetCustom and manages its lifecycle.
type Target struct {
	writer io.WriteCloser
	target *C.VipsTargetCustom
	ptr    unsafe.Pointer
	lock   sync.Mutex
}

// NewTarget creates Target from writer
func NewTarget(writer io.WriteCloser) *Target {
	Startup(nil)
	t := &Target{writer: writer}
	t.ptr = pointer.Save(t)
	t.target = C.create_go_custom_target(t.ptr)
	return t
}

// Close target
func (t *Target) Close() {
	if t == nil {
		return
	}
	t.lock.Lock()
	if t.ptr != nil {
		C.clear_target(&t.target)
		pointer.Unref(t.ptr)
		t.ptr = nil
		t.lock.Unlock()
		if t.writer != nil {
			_ = t.writer.Close()
			t.writer = nil
		}
		log("vipsgen", LogLevelDebug, fmt.Sprintf("closing target %p", t))
	} else {
		t.lock.Unlock()
	}
}
